\section{Ocean part}
\subsection{Implementation}
{\color{red} Density is not taken into account in the code:
it may be assumed as $\rho_a=1$ in the atmosphere: this can be
a source of errors}
\begin{itemize}
\item
In the ocean part, we use negative z grid levels.
$z_0$ is the bottom of the ocean and $z_{M}=0$ is the surface.
\item
We now note $k$ the index such that $z_{k-1} < \delta_{sl} \leq z_k$.
\item initialization: $e=e_{min}$ and $\theta = 280K$
% \item Boundary condition of the TKE:
% 	$e_0=\frac{e_{bb}|\tau_m|}{\rho_0}$, and
% 	boundary condition of mixing length is
% 		$l_0 = \kappa \frac{2.10^5\times |\tau_m|}{\rho_0}$
\item $N^2$ is computed with a linear equation of state:
	$N^2 = g \alpha \partial_z \theta$
\item Solar flux penetration: first, we make the rough assumption that
	the radiative fluxes are constant in the SL.
	Noting $Q_{sw}$ and $Q_{lw}$ the (positive downward)
	shortwave and longwave fluxes, the boundary condition for
		$\theta$ becomes (the FV free discretisation will be
		detailed later)
	\begin{equation}
		K \partial_z \theta^{n+1} = C_H |u^n(0) - u^n(\delta)|
		(\theta^n_s - \theta^{n+1}(\delta)) - \frac{
			Q_{sw} + Q_{lw} }{\rho_0 C_p}
	\end{equation}
\item Universal functions (see section
	\ref{ec:ND_Ocean_stabilityFunctionIntegration})
\item Possible input of energy due to surface waves ?
\item Mixing lengths

\end{itemize}
\begin{figure}
	\subimport{images/}{nouvelle_dis_neutre_ocean.pdf_tex}
	\caption{Surface layer scheme "FV free" in the oceanic SCM}
	\label{fig:ND_Ocean_nouvelle_dis_neutre}
\end{figure}

\begin{equation} \label{eq:ND_Ocean_tmprelation_tilde_bar}
\begin{aligned}
	\frac{\widetilde{h}}{h_{k-1/2}} (u(0) - \widetilde{u}) =
	(u(0) - \overline{u}_{k-1/2}) -
	(u(0) - u(\delta_{sl}))\tau_{sl, u} \\
\frac{\widetilde{h}}{h_{k-1/2}} (\theta_s - \widetilde{\theta}) =
	(\theta_s - \overline{\theta}_{k-1/2}) -
	(\theta_s - \theta(\delta_{sl}))\tau_{sl, \theta}
\end{aligned}
\end{equation}
with for $x = u, \theta$:
\begin{equation}
	\tau_{sl, x} = \frac{\frac{1}{{h_{k-1/2}}}\int_{\delta_{sl}}^{z_k} \ln(1+\frac{-z}{z_{0x}})- \psi_x(\frac{-z}{L_{MO}})
	dz}{\ln(1+\frac{-\delta_{sl}}{z_{0x}})- \psi_x(\frac{-\delta_{sl}}{L_{MO}})
    }
    =
 \frac{\frac{1}{{h_{k-1/2}}}
    \left[
	    (-z+z_{0x})\ln(1+\frac{-z}{z_{0x}})+z
    -
    z \Psi_m(\frac{-z}{L_{MO}}) \right]_{\delta_{sl}}^{z_k}
    }{\ln(1+\frac{-\delta_{sl}}{z_{0x}})- \psi_x(\frac{-\delta_{sl}}{L_{MO}})
    }
\end{equation}
and
$\alpha_{sl, x} = \frac{\widetilde{h}}{h_{k-1/2}} +
\tau_{sl, x}$
non-dimensional numbers.
Let us inject $u(\delta_{sl}) =
{\cal S}(\frac{\widetilde{h}}{2})$ and
$\theta(\delta_{sl}) = {\cal T}(\frac{\widetilde{h}}{2})$:
\begin{equation}
\begin{aligned}
\label{eq:ND_Ocean_relation_tilde_bar}
\alpha_{sl, u}\widetilde{u} = \overline{u}_{k-1/2} -
	\tau_{sl, u}
\widetilde{h}
	(\phi_k/3 + \phi_{k-1}/6) - (1 - \alpha_{sl, u})u(0)\\
\alpha_{sl, \theta}
\widetilde{\theta}
= \overline{\theta}_{k-1/2} - \tau_{sl, \theta}
	\widetilde{h}(\frac{{(\partial_z \theta)}_k}{3} + \frac{{(\partial_z \theta)}_{k-1}}{6})
 - (1 - \alpha_{sl, \theta})\theta_s
\end{aligned}
\end{equation}
The scheme can then use as boundary conditions at the surface layer:
\begin{equation}
\label{eq:ND_Ocean_boundaryConditionFVfree}
\begin{aligned}
	\frac{\alpha_{\rm sl, u} |u(0) - u(\delta_{\rm sl})|}
	{u_\star^2}K_{u,k} \phi_k =
	u(0) - \overline{u}_{k-1/2} - \frac{\widetilde{h}^2}{h_{k-1/2}}
	(\frac{\phi_k}{3} + \frac{\phi_{k-1}}{6})
	\\
  \frac{\alpha_{sl, \theta} }
	{C_H |u(0)-u(\delta_{sl})|}
	K_{\theta, k} (\partial_z \theta)_k = 
  \theta_s - \overline{\theta}_{k-1/2} - \frac{\widetilde{h}^2}{h_{k-1/2}}
	(\frac{{(\partial_z \theta)}_k}{3} +
	\frac{{(\partial_z \theta)}_{k-1}}{6}) 
	+ \frac{\alpha_{sl, \theta} Q_s }
	{C_H |u(0)-u(\delta_{sl})| \rho_0 C_p}
  \\
\end{aligned}
\end{equation}
Finally, the scheme at the first grid level above
the surface layer is for $u$:
\begin{equation}
\label{eq:ND_Ocean_prognosticu_FVfree}
    \begin{aligned}
(\partial_t + if)
	    \left(\frac{\widetilde{h}}{6h_{k-1}} 
    \phi_k
    +
    \left(
	    \frac{\widetilde{h}}{3h_{k-1}} 
	    + \frac{h_{k-3/2}}{3h_{k-1}}
    \right)
	    \phi_{k-1}
	    + \frac{h_{k-3/2}}{6h_{k-1}} \phi_{k-2}\right)
    = \\
	     \frac{K_{u, k} \phi_{k} -
	    K_{u,k-1} \phi_{k-1} }{\widetilde{h}h_{k-1}} -
\frac{K_{u, k-1} \phi_{k-1} - K_{u, k-2} \phi_{k-2}}
	    {h_{k-3/2}h_{k-1}} + \widetilde{F} - F_{k-3/2}
    \end{aligned}
\end{equation}
\begin{equation}
	\label{eq:ND_Ocean_semiDiscreteEkmanEqFVfree}
	(\partial_t+if) \left(\frac{1}{\alpha_{\rm sl, u}}
	\left(\overline{u}_{k-1/2} - \widetilde{h}\tau_{\rm sl, u}
	(\frac{\phi_k}{3} + \frac{\phi_{k-1}}{6}) - 
	(1-\alpha_{\rm sl, u})u(0)\right)\right)
	= \frac{K_{u, k}\phi_{k} - K_{u,k-1} \phi_{k-1}}{\widetilde{h}}
	+ \widetilde{F}
\end{equation}
and the same applies for $\theta$:
\begin{equation}
\label{eq:ND_Ocean_prognosticPT_FVfree}
    \begin{aligned}
\partial_t \left(\frac{\widetilde{h}}{6h_{k-1}} 
	    {(\partial_z \theta)}_k
    +
    \left(
	    \frac{\widetilde{h}}{3h_{k-1}} 
	    + \frac{h_{k-3/2}}{3h_{k-1}}
    \right)
	    {(\partial_z \theta)}_{k-1}
	    + \frac{h_{k-3/2}}{6h_{k-1}} {(\partial_z \theta)}_{k-2}\right)
    = \\
	    \frac{K_{\theta, k} {(\partial_z \theta)}_{k} -
	    K_{\theta, k-1} {(\partial_z \theta)}_{k-1} }{\widetilde{h}h_{k-1}}
	    -\frac{K_{\theta, k-2} {(\partial_z \theta)}_{k-1} -
	    K_{\theta, k-2} {(\partial_z \theta)}_{k-2}}
	    {h_{k-3/2}h_{k-1}} + \widetilde{F}_\theta - F_{\theta, k-3/2}
    \end{aligned}
\end{equation}
\begin{equation}
	\label{eq:ND_Ocean_semiDiscreteEkmanEqPTFVfree}
	\partial_t \left(\frac{1}{\alpha_{\rm sl, \theta}}
	\left(
	\overline{\theta}_{k-1/2} - \tau_{sl, \theta}
	\widetilde{h}(\frac{{(\partial_z \theta)}_k}{3} +
	\frac{{(\partial_z \theta)}_{k-1}}{6})
	 - (1 - \alpha_{sl, \theta})\theta_s
	\right) \right)
	= \frac{K_{\theta, k}{(\partial_z \theta)}_{k} -
	K_{\theta,k-1} {(\partial_z \theta)}_{k-1}}{\widetilde{h}}
	+ \widetilde{F}_\theta 
\end{equation}

\subsection{Computing $\tau_{\rm sl}$: stability function integration}
\label{sec:ND_Ocean_stabilityFunctionIntegration}
In the ocean, we use the universal function of \citep{large2019similarity} (as in \citep{pelletier2021two})
\begin{equation}
	\phi^m(\zeta) = \phi^h(\zeta) = 1+5\zeta, ~~~ \zeta \geq 0
\end{equation}
\begin{equation}
	\phi^m(\zeta) = (1-14\zeta)^{-1/3}, ~~~ \zeta < 0
\end{equation}
\begin{equation}
	\phi^h(\zeta) = (1-25\zeta)^{-1/3}, ~~~ \zeta < 0
\end{equation}
and the first integrated form, $\psi(\zeta)= \int_0^\zeta \frac{1-\phi(x)}{x}dx$ is for $\zeta<0$
\begin{equation}
	\psi^x(\zeta)  = \sqrt{3}\left[\arctan(\sqrt{3}) -
	\arctan\left(\frac{\sqrt{3}}{3}(2C_{\{m,h\}}+1)\right)\right]
	+ \frac{3}{2}\ln \left(\frac{(C_{\{m,h\}})^2 + C_{\{m,h\}} + 1}{3}\right)
\end{equation}
and $\psi^x(\zeta) = -5\zeta$ for $\zeta \geq 0$
where $C_m = (1-14\zeta)^{1/3}$, $C_h = (1-25\zeta)^{1/3}$.
We now compute its volume-averaged form $\Psi^{\{m,h\}}(\zeta)= \frac{1}{\zeta}\int_0^\zeta \psi^{\{m,h\}}(x)dx$.
\par
First,
\begin{equation}
	\int \ln (C_m^2+C_m+1)d\zeta
	= -2 \frac{\zeta}{3} - \frac{1}{28}C_m^2 - \frac{1}{14}C_m
	+\zeta\ln (C_m^2+C_m+1) + {\rm const}
\end{equation}
and
\begin{equation}
	\int \arctan (\frac{2C_m+1}{\sqrt{3}})d\zeta
	= \frac{\sqrt{3}}{56}C_m(C_m-2)
	+ \zeta \arctan (\frac{2C_m+1}{\sqrt{3}}) + {\rm const}
\end{equation}
Putting them together, we get
\begin{equation}
\begin{aligned}
	\Psi^m(\zeta)=\sqrt{3}\arctan(\sqrt{3})- 
	\frac{3}{2}\ln(3) -
	\frac{3}{56\zeta}C_m(C_m-2)
	- \sqrt{3} \arctan (\frac{2C_m+1}{\sqrt{3}})
	\\
	-1 - \frac{3}{56\zeta}C_m^2 - \frac{3}{28\zeta}C_m
	+\frac{3}{2}\ln (C_m^2+C_m+1)
	+ \frac{{\rm const}}{\zeta}.
\end{aligned}
\end{equation}
After simplification, using $\lim_\zeta\to0 \int_0^\zeta\psi(x)dx = 0$:
\begin{equation}
\begin{aligned}
\Psi^{\{m,h\}}(\zeta)= -\frac{5}{2}\zeta, ~~~~ \zeta \geq 0 \\
	\Psi^{\{m,h\}}(\zeta)=
	\psi^{\{m,h\}}(\zeta)
	- \frac{(2C_{\{m,h\}}+1)(C_{\{m,h\}} - 1)}
	{2\left((C_{\{m,h\}})^2 + C_{\{m,h\}} + 1\right)}, ~~~~ \zeta < 0
\end{aligned}
\end{equation}
We finally get for $u$:
\begin{equation}
	\tau_{sl, u} = \frac{\frac{1}{{h_{k-1/2}}}
    \left[
	    (-z+z_{0m})\ln(1+\frac{-z}{z_{0m}})+z
    -
    z \Psi_m(\frac{-z}{L_{MO}}) \right]_{\delta_{sl}}^{z_k}
    }{\ln(1+\frac{-\delta_{sl}}{z_{0m}})- \psi_u(\frac{-\delta_{sl}}{L_{MO}})
    }
\end{equation}
and for $\theta$:
\begin{equation}
	\tau_{sl, \theta} =  \frac{1}{{h_{k-1/2}}}\frac{(1 -
		\frac{Q_{lw}}{\theta_o^{\star}u_o^{\star}\rho_0 c_p})
    \left[
	    (-z+z_{0H})\ln(1+\frac{-z}{z_{0H}})+z
    -
    z \Psi_m(\frac{-z}{L_{MO}}) \right]_{\delta_{sl}}^{z_k}
	- \frac{Q_{sw}}{\theta_o^{\star}u_o^{\star}\rho_0 c_p}
	\int_{\delta_o}^{z_k}
		E(z) dz
    }{(1 - \frac{Q_{lw}}{\theta_o^{\star}u_o^{\star}\rho_0 c_p})
	    \ln(1+\frac{-\delta_{sl}}{z_{0H}})- \psi_\theta(\frac{-\delta_{sl}}{L_{MO}})
	    -\frac{Q_{sw}}{\theta_o^{\star}u_o^{\star}\rho_0 c_p} E(\delta_{sl})
    }
\end{equation}
where $E(z) = \int_{z}^0 \frac{\phi^h_o(-x/L_o)
		\sum A_i \exp (k_i x)
		}{x}dx$


\subsection{Radiative fluxes}
We note $Q_{sw}$ and $Q_{lw}$ the shortwave and longwave positive
downward fluxes. A new variable that is similar to a friction
scale but depends on $z$ can be defined:
\begin{equation}
\theta^\star_{o, \rm rad}(z) =
	\theta^\star_{o}(z) -
	\frac{Q_{sw}(z) + Q_{lw}}{u^{\star}_o\rho_0 c_p}.
\end{equation}
The changes and implementation choices are listed hereafter from
the smallest changes to the greatest:
\begin{enumerate}
	\item Obhukov length is \textbf{not} changed directly and
		still is $\kappa g \alpha \lambda_\theta
		\theta^\star_a / (u^\star_o)^2$.
	\item Initialization and boundary conditions for test cases:
		$K\partial_z \theta = \theta^{\star}_o u^{\star}_o$
		is replaced by
		$K\partial_z \theta = \theta^{\star}_o u^{\star}_o
		- \frac{Q_{sw} + Q_{lw}}{\rho_o c_p}$.
	\item Reconstruction: noting that $\theta_{z_M}$ is
		\textbf{not} directly affected by the
		radiative fluxes, when computing $\theta(z>\delta_o)$
		we use the integrated radiative fluxes of
		equation \eqref{eq:ND_Ocean_skinbulk}
	\item FV free discretisation: since the reconstruction
		of $\theta_{z_M} - \theta(z)$ is affected by
		the radiative fluxes, $\tau_{\rm sl}$ is also
		changed. Since $\tau_{\rm sl}$ relies on an
		integration over the SL, the explicit form
		of $\tau_{\rm sl}$ is not known in general
		and we compute a numerical approximation of
		$\frac{1}{h_{k-1/2}}\int_{z=\delta_o}^{z_k}
		\int_{x=z}^0 \frac{\phi^h_o(-x/L_o)
		\sum A_i \exp (k_i x)
		}{z}dx dz$
		.
	\item In boundary conditions, $C_H |u(0)-u(\delta_o)|$ or
		$C_H |u(\delta_a)-u(\delta_o)|$ is used.
		its value ($\frac{\kappa u^{\star}_o}
		{\ln(1-\frac{\delta_o}{z_{0H}}) - \psi_h(\zeta)}$)
		is changed, still following
		\eqref{eq:ND_Ocean_skinbulk}.
	\item Bulk formulae (function \verb|__friction_scales|):
		When computing
		$\frac{\kappa (\theta(\delta_a) - \theta(\delta_o))}
		{\theta_a^{\star}}$,
		we use, like in
		Equation (43) of \citep{pelletier2021two}:
	\begin{equation}
		\label{eq:ND_Ocean_skinbulk}
		\frac{\kappa (\theta(0) - \theta(\delta_o))}
		{\theta_o^{\star}} = (1 -
		\frac{Q_{lw}}{\theta_o^{\star}u_o^{\star}\rho_0 c_p})
		\left(\ln (1 - \frac{\delta_o}{z_{0H}}) -
		\psi_h(\frac{-\delta_o}{z_{0H}})\right)
		- \frac{Q_{sw}(0)}{\theta_o^{\star}u_o^{\star}\rho_0 c_p}
		\int_{\delta_o}^0 \frac{\phi^h_o(-z/L_o)
		\sum A_i \exp (k_i z)
		}{z}dz.
	\end{equation}
\end{enumerate}
