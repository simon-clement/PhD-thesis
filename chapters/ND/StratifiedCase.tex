\section{Stratified case}
Now that all the ideas have been presented in the Neutral case,
we extend the discussion to the case of a stratified column.
A stratified fluid has layers of different densities.
We assume for simplicity that the atmosphere
is dry and that the density variation is
proportional to the variation of the temperature:
\begin{equation}
	\partial_z \rho \propto
	- \partial_z \theta.
\end{equation}
The stratification is hence given by a temperature profile:
if the temperature increases with $z$, the column is said
to be stable and the vertical mixing is reduced. This is
typically the case above sea ice or during the night.
On the contrary an unstable stratification comes from
a decreasing temperature with $z$: it happens
during daytime of diurnal cycles and enhance the
vertical mixing.
%
Finally, if the temperature is a constant, the neutral case is
recovered.
\par
We first discuss the continuous and semi-discrete in space
equations, then extend the previous discussion on the wall law to
Monin-Obukhov Similarity Theory (MOST).
Section \ref{sec:ND_StratifiedCase_turbulentVisc} gives the
profile of viscosities depending on the turbulent kinetic energy
(TKE).
\subsection{Continuous model and Finite Volumes discretization}
\subsubsection{Continuous model}
The continuous equations stay the same for $u$
(see \eqref{eq:ND_NeutralCase_continuousModel}),
except that the turbulent viscosity and the
friction scale $u*$ depends on the temperature $\theta$:
\begin{subequations}
	\label{eq:ND_StratifiedCase_continuousModel}
	\begin{equation}
	\label{eq:ND_StratifiedCase_EkmanEq}
\partial_t \theta -\partial_z (\partial_z K_{\theta} \theta)
	= F_{\theta},~~~~~~~~~~~~~~ z \geq \delta_{sl}
	\end{equation}
	\begin{equation}
	\label{eq:ND_StratifiedCase_ConstantFlux}
	\left.K_\theta \partial_z \theta
	\right|_{z\leq \delta_{\rm sl}}
	= \theta_\star u_\star = C_H
	||u(\delta_{\rm sl}) - u(0)||
	\left(\theta(\delta_{\rm sl}) - \theta_{s}\right)
	,~~~ z < \delta_{sl}
	\end{equation}
\end{subequations}
The viscosities $K_u, K_\theta$ will be detailed with
the discretization of the turbulent kinetic energy in section
\ref{sec:ND_StratifiedCase_turbulentVisc}.
In the surface layer, Monin-Obukhov Similarity Theory (MOST)
profiles for $u$ and $\theta$ are
\begin{equation}
\label{eq:ND_StratifiedCase_MOST}
\begin{aligned}
	||u(z)-u(0)|| = \frac{u_\star}{\kappa}
    \left(
	\log(1+\frac{z}{z_{0M}})
    - \psi_u(\frac{z}{L_{MO}})
	+ \psi_u(\frac{z_{0M}}{L_{MO}})
    \right)
    \\
    \theta(z) - \theta_s = 
    \frac{\theta_\star}{\kappa}
    \left(
	\log(1+\frac{z}{z_{0H}})
    - \psi_\theta(\frac{z}{L_{MO}})
	+ \psi_\theta(\frac{z_{0H}}{{L_{MO}}})
    \right)
\end{aligned}
\end{equation}
where $L_{MO} = \frac{\theta(\delta_{\rm sl})
u_\star^2}{\theta_\star \kappa g }$. We will use
$C_H|u(\delta_{sl})- u(0)| = 
\frac{u_\star \kappa}{\log(+1\frac{z}{z_{0H}})
    - \psi_\theta(\frac{z}{L_{MO}})
    + \psi_\theta(\frac{z_{0H}}{{L_{MO}}})}$
Similarly to the neutral case, the semi-discrete in time
boundary condition is not explicit:
$C_H^n|u^n(\delta_{sl})- u(0)|$ is computed with the values
at the current time step whereas the temperature variation
is taken in the time $n+1$: the boundary condition for temperature
is
\begin{equation}
	K_\theta \partial_z \theta = C_H^n|u^n(\delta_{sl})- u(0)| (\theta^{n+1}(\delta_{\rm sl}) - \theta_s), ~~~~ z < \delta_{\rm sl}
\end{equation}

\subsubsection{Finite Volumes discretization}
The discretization of $u$ is exactly the same as in the
neutral case (\eqref{eq:ND_NeutralCase_semiDiscreteEkmanEq} and \eqref{eq:ND_NeutralCase_prognosticEqFV}) and the discretization of 
the potential temperature is very similar:
the average potential temperature $\overline{\theta}_{m+1/2}$
evolves with
\begin{equation}
\label{eq:ND_StratifiedCase_semiDiscreteEkmanEqPT}
    \partial_t \overline{\theta}_{m+1/2}
    - \frac{K_{\theta, m+1} {(\partial_z \theta)}_{m+1} - K_{\theta, m} {(\partial_z \theta)}_m}{h_{m+1/2}}
	= \overline{F}_{\theta, m+1/2}
\end{equation}
And the derivative of temperature at $z_{m-1}, z_m, z_{m+1}$ solves
\begin{equation}
\begin{aligned}
\label{eq:ND_StratifiedCase_prognosticPT_FV}
\partial_t \left( \frac{h_{m-1/2}}{6} {(\partial_z \theta)}_{m-1} 
+ \frac{2h_m}{3} {(\partial_z \theta)}_m  
+ \frac{h_{m+1/2}}{6} {(\partial_z \theta)}_{m+1} \right)& \\
-
    \left(
	\frac{K_{\theta, m+1}}{ h_{m+1/2}}{(\partial_z \theta)}_{m+1} - \frac{2 h_m K_{\theta, m}}{h_{m-1/2} h _{m+1/2}}{(\partial_z \theta)}_m + \frac{K_{\theta, m-1}}{ h_{m-1/2}}{(\partial_z \theta)}_{m-1}
    \right)
	&= \overline{F}_{\theta, m+1/2} - \overline{F}_{\theta, m-1/2}
\end{aligned}
\end{equation}
We also extend the surface scheme strategies for the temperature:
\begin{itemize}
	\item With Finite Differences the evolution equation is
		solved at $z_{\frac{1}{2}}$ with the surface flux:
		\begin{equation}
			\underbrace{K_\theta
			\partial_z \theta_0^{n+1}}_{\text{
				Surface flux
			}} =
			\underbrace{C_H|u^n_{\frac{1}{2}}- u(0)|
			(\theta_{\frac{1}{2}}^{n+1}
			- \theta_s)}_{\text{FD values at }
			z_{\frac{1}{2}}}.
		\end{equation}
	\item With "FV pure" the evolution equation is solved in all
		the first grid level with the reconstructed
		value $\theta(\delta_{sl}) = {\cal T}_{1/2}(0)$:
		\begin{equation}
			\underbrace{K_\theta
			\partial_z \theta_0^{n+1}}_{\text{
				Surface flux
			}} =
			\underbrace{C_H
			|{\cal S}_{1/2}^{n}(0)- u(0)|
			({\cal T}_{1/2}^{n+1}(0)
			- \theta_s)}_{\text{Reconstructions at }
			z_{\frac{1}{2}}}.
		\end{equation}
	\item With "FV1" the evolution equation is solved in all
		the first grid level with the averaged-value
		assumption that $\theta(\delta_{sl}) =
		\overline{\theta}_{\frac{1}{2}}$:
		\begin{equation}
			\underbrace{K_\theta
			\partial_z \theta_0^{n+1}}_{\text{
				Surface flux
			}} =
			\underbrace{C_H
			|\overline{u}_{\frac{1}{2}}^n- u(0)|
			(\overline{\theta}_{\frac{1}{2}}^{n+1}(0)
			- \theta_s)}_{\text{Averaged values around }
			z_{\frac{1}{2}}}.
		\end{equation}
	\item With "FV2" in the first grid level
		the MOST profile for $\theta$ is assumed as in
		\cite{nishizawa_surface_2018}.
		The boundary condition is the flux at the top of the
		surface layer $\delta_{sl}=z_1$,
		using the reconstructed solution at $z_1$:
		\begin{equation}
			\underbrace{K_\theta
			\partial_z \theta^{n+1}_1}_{\text{
				Flux at
			} z_1} =
			\underbrace{C_H
			|{\cal S}_{3/2}^{n}(-\frac{h_\frac{3}{2}}{2})
			- u(0)|
			({\cal T}_{3/2}^{n+1}
			(-\frac{h_\frac{3}{2}}{2})
			- \theta_s)}_{\text{Reconstructions at }
			z_{1}}.
		\end{equation}
\end{itemize}
The limitations of the strategies shown in the neutral case are the
same for the temperature: the "FV1" approach is biased because
of the approximation
$\overline{\theta}_{\frac{1}{2}}=\theta(\delta_{\rm sl})$ and
both "FV1" and "FV pure" assume that the evolution equation occurs
in the surface layer and approximate a MOST profile with
a quadratic spline.
The value of $K_\theta$ at $z_0$ cannot be set to the molecular
diffusivity in those cases for the same reason as in the neutral case.
%
Moreover, the discretizations force $\delta_{sl}$ to the first
grid level $z_{\frac{1}{2}}$ (or $z_1$ in the case of "FV2").
We now extend the "FV free" surface scheme to eliminate those
limitations.
\subsection{FV free}
\label{sec:ND_StratifiedCase_FVfree}
In this section \ref{sec:ND_StratifiedCase_FVfree} we follow
step by step the derivation of the neutral "FV free" scheme and
apply it to this stratified case. The stratification adds no
complexity: we hence present the derivation directly for
any $\delta_{\rm sl} \geq 0$.
Let $k$ such that $z_k \leq \delta_{\rm sl} < z_{k+1}$.
As in the neutral case, the cell $[z_k, z_{k+1}]$ is split
into two parts for the "FV free" surface flux scheme.
The first part $[z_k,\delta_{\rm sl}]$ is contained
in the surface layer where the temperature and wind
follow \eqref{eq:ND_StratifiedCase_MOST}.
The second part is the
"subcell" $[\delta_{\rm sl}, z_{k+1}]$ of size $\widetilde{h}$, of
averages $\widetilde{u}, \widetilde{\theta}$
and of subgrid reconstructions
\begin{equation}
\begin{aligned}
{\cal S}_{k+1/2}(\xi) = \widetilde{u} +
	\frac{\phi_{k+1} + \phi_{k}}{2} \xi
+ \frac{\phi_{k+1} - \phi_{k}}{2\widetilde{h}}
	\left(\xi^2 - \frac{\widetilde{h}^2}{12}\right) \\
{\cal T}_{k+1/2}(\xi) = \widetilde{\theta}_{1/2} +
	\frac{{(\partial_z \theta)}_{k+1} + 
		{(\partial_z \theta)}_{k}}{2} \xi
+ \frac{{(\partial_z \theta)}_{k+1} - {(\partial_z \theta)}_{k}}
	{2\widetilde{h}}
	\left(\xi^2 - \frac{\widetilde{h}^2}{12}\right)
\end{aligned}
\end{equation}
where $\xi = z - (z_{k+1} - \frac{\widetilde{h}}{2})$ is defined
for $\delta_{\rm sl} < z < z_{k+1}$.
The relation between
$\overline{u}_{k+1/2}, \overline{\theta}_{k+1/2}$ and
$\widetilde{u},\widetilde{\theta}$ is, similarly to the neutral case:
\begin{equation} \label{eq:ND_StratifiedCase_tmprelation_tilde_bar}
\begin{aligned}
	\frac{\widetilde{h}}{h_{k+1/2}} (\widetilde{u}-u(0)) &=
	\overline{u}_{k+1/2}-u(0) - 
	(u(\delta_{sl})-u(0)) \tau_{sl, u}\\
	\frac{\widetilde{h}}{h_{k+1/2}}
	(\widetilde{\theta} - \theta_s) &=
	(\overline{\theta}_{k+1/2}-\theta_s) -
	(\theta(\delta_{sl})-\theta_s)\tau_{sl, \theta}
\end{aligned}
\end{equation}
where the non-dimensional numbers $\tau_{sl, u}, \tau_{sl, \theta}$
depend on the stratification. For $x=u, \theta$,
\begin{equation}
\tau_{sl, x} = \frac{\frac{1}{{h_{1/2}}}\int_{z_k}^{\delta_{sl}} \log(1+\frac{z}{z_{0x}})- \psi_x(\frac{z}{L_{MO}})
	dz}{\log(1+\frac{\delta_{sl}}{z_{0x}})- \psi_x(\frac{\delta_{sl}}{L_{MO}})
    }
    =
 \frac{\frac{1}{{h_{1/2}}}
    \left[
	    (z+z_{0x})\log(1+\frac{z}{z_{0x}})-z
    +
    z \Psi_x(\frac{z}{L_{MO}}) \right]_{z_k}^{\delta_{sl}}
    }{\log(1+\frac{\delta_{sl}}{z_{0x}})- \psi_x(\frac{\delta_{sl}}{L_{MO}})
    }.
\end{equation}
Note that we used $\Psi_x$, the averaged form of the universal
profile stability functions defined in \citep{nishizawa_surface_2018}.
%
Since $\log(1+\frac{z}{z_{0x}})-
\psi_x(\frac{z}{L_{MO}})$ is non-negative and increase with $z$ even
in strongly unstable situations,
$0 \leq \tau_{sl, x} < 1$ and as in the neutral case
$\tau_{sl, x}=0 \iff \widetilde{h}=h_{k+1/2}$. This let us retrieve
the "FV2" surface flux scheme by setting the height of the surface
layer to exactly $z_1$.
We define the non-dimensional number
$\alpha_{sl, x} = \frac{\widetilde{h}_{1/2}}{h_{1/2}} + \tau_{sl, x}$.
The increasing nature of MOST profiles gives that
$0 < \alpha_{sl, x} \leq 1$ increases with $\widetilde{h}$.
Let us inject $u(\delta_{sl}) =
{\cal S}(-\frac{\widetilde{h}}{2})$ and
$\theta(\delta_{sl}) = {\cal T}(-\frac{\widetilde{h}}{2})$:
\begin{equation}
\begin{aligned}
\label{eq:ND_StratifiedCase_relation_tilde_bar}
	\alpha_{sl, u}\widetilde{u} &= \overline{u}_{k+1/2} +
	\tau_{sl, u}
\widetilde{h}
	(\frac{\phi_k}{3} + \frac{\phi_{k+1}}{6})
	- (1- \alpha_{sl, u}) u(0)\\
\alpha_{sl, \theta}
\widetilde{\theta}
	&= \overline{\theta}_{k+1/2} + \tau_{sl, \theta}
	\widetilde{h}(\frac{{(\partial_z \theta)}_k}{3} + \frac{{(\partial_z \theta)}_{k+1}}{6})
 - (1 - \alpha_{sl, \theta})\theta_s
\end{aligned}
\end{equation}
Finally, equations \eqref{eq:ND_NeutralCase_boundaryCondFVfree} and
\eqref{eq:ND_NeutralCase_semiDiscreteEkmanEqFVfree} can be used for
$u$ and the equations for $\theta$ are similar:
the boundary condition of "FV free" is
\begin{equation}
	\label{eq:ND_StratifiedCase_semiDiscreteEkmanEqFVfree}
	\underbrace{K_{\theta, \delta} (\partial_z \theta)_\delta}_{
		\text{Flux at } \delta_{sl}
	} = 
	C_H |u(\delta_{sl})-u(0)|
	\underbrace{
	\frac{
  \overline{\theta}_{k+1/2} - \frac{\widetilde{h}^2}{h_{k+1/2}}
	(\frac{{(\partial_z \theta)}_k}{3} +
	\frac{{(\partial_z \theta)}_{k+1}}{6}) 
  - \theta_s
}{\alpha_{sl, \theta}}
	}_{\text{Reconstruction at } \delta_{sl}}
\end{equation}
and the evolution equation of the first active grid level is
\begin{equation}
    \begin{aligned}
	\label{eq:ND_StratifiedCase_semiDiscreteEkmanEqPTFVfree}
	    \partial_t \left(\frac{1}{\alpha_{\rm sl, \theta}}
	    \left(
	    \overline{\theta}_{k+1/2} + \tau_{sl, \theta}
	\widetilde{h}(\frac{{(\partial_z \theta)}_k}{3} +
	\frac{{(\partial_z \theta)}_{k+1}}{6})
	 - (1 - \alpha_{sl, \theta})\theta_s
	    \right) \right)&
	= \\
	    \frac{K_{\theta, k+1}{(\partial_z \theta)}_{k+1} -
	K_{\theta,k} {(\partial_z \theta)}_k}{\widetilde{h}}
	    + &\overline{F}_{\theta, k+1/2}.
    \end{aligned}
\end{equation}
The prognostic equation \eqref{eq:ND_StratifiedCase_prognosticPT_FV}
for $\partial_z \theta$ is also adjusted for the first
level to replace $h_{k+1/2}$ by $\widetilde{h}$.
\subsection{Turbulent viscosities}
\label{sec:ND_StratifiedCase_turbulentVisc}
\subsubsection{Finite Volumes discretization of TKE}
The Turbulent Kinetic Energy (TKE) evolves with the equation
\begin{equation}
\label{eq:ND_StratifiedCase_TKE}
    \begin{aligned}
    \partial_t e =
    \underbrace{\partial_z \left(K_e
    \partial_z e\right)}_{\text{diffusion}}
    + \underbrace{K_u ||\partial_z u||^2}_{\text{shear}} 
    - \underbrace{K_{\theta} N^2 }_{\text{buoyancy}}
    - \underbrace{c_{\epsilon}
    \frac{e^{3/2}}{l_{\epsilon}(z)}}_{\text{dissipation}}.
    \end{aligned}
\end{equation}
The turbulent viscosities $K_u, K_{\theta}$ and $K_e$ are computed
with $(K_u, K_\theta, K_e) = (C_m , C_s \phi_z, C_e)l_m \sqrt{e}$.
$l_m = \sqrt{l_{\rm up} l_{\rm down}}$ and
$l_\epsilon = \min{(l_{\rm up}, l_{\rm down})}$
are obtained with the fourth method described in
\cite{lemarie_simplified_2021} named $l^\star_{\rm D80}$:
\begin{enumerate}
	\item Define
		\begin{equation}
			\label{eq:ND_StratifiedCase_lD80}
			l^\star_{\rm D80} = \frac{2\sqrt{e}}
			{c_0 ||\partial_z u|| + \sqrt{
				c_0^2 ||\partial_z u||^2 + 2 N^2
			}};
		\end{equation}
	\item initialize $l_{\rm up}$ and $l_{\rm down}$ to
		$l^\star_{\rm D80}$;
	\item limit $l_{\rm up}$ by the distance to the top and to
		a strongly stratified area: this is done by
		ensuring $-\partial_z l_{\rm up} < 1$ and
		$l_{\rm up}(z_{\rm top}) \approx 0$.
	\item limit $l_{\rm down}$ by the distance to the surface
		and to a strongly stratified area: this is done by
		ensuring $\partial_z l_{\rm down} < 1$ and
		an appropriate surface layer value.
		The value here is not zero so that the surface layer
		links correctly with the computational domain.
\end{enumerate}
\begin{figure}
	\centering
	\includegraphics[scale=0.6]{images/mixing_lengths.pdf}
	\caption{Typical vertical profiles of the mixing lengths
	(left) reported with the corresponding TKE (right).
	It is seen that $l_{up}$ is limited for
	$z\in (100 \; {\rm m}, 230\; {\rm m})$ whereas
	$l_{down}$ is limited for $z<200 \;{\rm m}$. The surface flux
	scheme used is "FV free" which is why the
	profiles start at $\delta_{sl} = 10\;{\rm m}$.}
	\label{fig:ND_StratifiedCase_mixing_lengths}
\end{figure}
Figure \ref{fig:ND_StratifiedCase_mixing_lengths} shows vertical
profiles of $l_{up}, l_{down}, l_m, l_{D80}^\star$. The value of
$l_{down}$ in the surface layer is detailed in
subsection \ref{sec:ND_StratifiedCase_mixing_lengths_match}.
%
\paragraph{Turbulent Kinetic Energy in the computational domain}
The discretisation of the turbulent kinetic energy
requires some care. The Finite Volume scheme used for
$u$ and $\theta$ is not used and we use instead a Finite Differences
method which has a positivity conservation property.
The energy $e$ and the lengths scales
$l_m, l_\epsilon$ are evaluated at the interfaces
$z_m$ between the cells:
\begin{equation}
\label{eq:ND_StratifiedCase_SemiDiscreteTKE}
    \left(
    \frac{c_\epsilon \sqrt{e^n_m}}{l_\epsilon}
    + \partial_t
    \right) e_m
    =\frac{K_{e,m+1/2} (\partial_z e)_{m+1/2} -
    K_{e,m-1/2} (\partial_z e)_{m-1/2}}{h_{m}}
    + K_u ||\partial_z u||^2
    - K_\theta N^2
\end{equation}
The implicit dissipation ensures the conservation
of the positivity of $e$, as long as
$K_u ||\partial_z u||^2 - K_\theta N^2$ is positive.
In the cells where the buoyancy is stronger than the shear,
$K_\theta N^2$ is multiplied by
$\frac{e^{n+1}}{e^n}$. This implicit buoyancy term is known
as the "Patankar's trick" \citep{lemarie_simplified_2021}.
% Let us assume that in each cell, $e$ is not varying too much and
% $l_\epsilon$ is constant.
% We use Patankar's trick
% \footnote{
% 	multiplying buoyancy by $\frac{\overline{e}^{n+1}}{\overline{e}^n}$ when buoyancy is greater than shear
% to ensure positivity preservation of $\overline{e}$ {\color{red}[ref ?]
% }} even if it does not guarantee positivity of TKE when
% dealing with Finite Volumes.
% Shear and buoyancy are also assumed to be constant in each cell:
% \begin{equation}
% \label{eq:ND_StratifiedCase_SemiDiscreteTKE}
%     \left(
%     \frac{c_\epsilon \sqrt{\overline{e}^n}}{l_\epsilon}
%     + \partial_t
%     \right) \overline{e}
%     =\frac{K_{e,m+1} (\partial_z e)_{m+1} -
%     K_{e,m} (\partial_z e)_{m}}{h_{m+1/2}}
%     + K_u ||\partial_z u||^2
%     - K_\theta N^2
% \end{equation}
% Similarly to $\theta$ and $u$, the prognostic equation
% to find the spatial derivative of the TKE at 
% the borders of the cells is
% \begin{equation}
% \label{eq:ND_StratifiedCase_prognosticTKE_FV}
% \begin{aligned}
% &\partial_t
% \left(
%     h_{m-1/2}\frac{(\partial_z e)_{m-1}}{6}+
%     h_m\frac{2(\partial_z e)_{m}}{3}+
%     h_{m+1/2}\frac{(\partial_z e)_{m+1}}{6}
% \right)
% \\&-
%     \left(\frac{K_{e,m+1} (\partial_z e)_{m+1} -
%         K_{e,m} (\partial_z e)_{m}}{h_{m+1/2}}
% -
%     \frac{K_{e,m} (\partial_z e)_{m} -
%         K_{e,m-1} (\partial_z e)_{m-1}}{h_{m-1/2}}
%         \right)
% \\
% &- \left(K_{u} ||\partial_z u||^2
% -  K_\theta N^2 
% - \frac{c_\epsilon \sqrt{\overline{e}}}{l_\epsilon} \overline{e}
% \right)_{dm} = 0
% \end{aligned}
% \end{equation}
% where the index $X_{dm}$ is a shortcut for $X_{m+1/2} - X_{m-1/2}$.

\paragraph{Boundary conditions}
In the surface layer because of the strong mixing $e$
is at the equilibrium between shear, buoyancy and dissipation.
$e(z<\delta_{sl}) = \left(\frac{l_\epsilon}{c_\epsilon}
(K_u||\partial_z u||^2 - K_\theta N^2)\right)^{2/3}$, where
$\partial_z u$ and $N^2$ are given by MOST.
A homogeneous Neumann boundary condition is used at the top.

\subsubsection{Matching viscosities at the surface layer}
\label{sec:ND_StratifiedCase_mixing_lengths_match}
In order to obtain a regular solution out of the "FV free"
discretization, we derive here the constraints on mixing length
and on TKE inside the surface layer.
A subgrid model that suit both
surface layer and free turbulence was proposed by
\citep{redelsperger_simple_2001}, motivated by measurements.
In the neutral case, this subgrid model leads to linear
mixing lengths $l_m, l_{\epsilon}$ in the surface layer;
with stratified fluids, the formulation is more sophisticated
and depends strongly on the Obukhov length.
The link between the surface layer and the regions
further away from the surface is ensured with a linear combination
between the two regimes.
%
\par
Instead of following the latter method,
we aim to keep the mixing lengths \eqref{eq:ND_StratifiedCase_lD80}
of the computational domain and
to set a particular boundary condition for $l_{down}$
to satisfy the Monin-Obukhov Similarity Theory.
Assuming that 
\begin{equation}
	\label{eq:ND_StratifiedCase_viscosities_assumption}
K_m = C_m l_m \sqrt{e} ~~\text{and}~~
K_\theta = C_s l_m \phi_z \sqrt{e}
\end{equation}
 inside the SL, we have
for $z\leq \delta_{\rm sl}$
\begin{enumerate}
\item
	% 	Constant flux layer hypothesis and Robin boundary condition:
	% \begin{subequations}
	% \begin{equation}
	% 	\label{eq:ND_StratifiedCase_K_partial_z_u}
	% 	K_m \partial_z u = u_\star^2
	% 	\frac{u(\delta_{sl})-u(0)}{|u^n(\delta_{sl})-u(0)|}
	% \end{equation}
	% \begin{equation}
	% 	\label{eq:ND_StratifiedCase_partial_z_u}
	% 	\partial_z u = u_\star \frac{\phi_m(z/L_{MO})}{\kappa (z + z_{0M})}\frac{u(\delta_{sl})-u(0)}{|u^n(\delta_{sl})-u(0)|}
	% \end{equation}
	% \begin{equation}
	% 	\label{eq:ND_StratifiedCase_partial_z_theta}
	% 	\partial_z \theta = \theta_\star \frac{\phi_h(z/L_{MO})}{\kappa (z + z_{0H})}, ~~~ K_\theta \partial_z \theta = u_\star \theta_\star
	% \end{equation}
	% \end{subequations}
	% Leading to 
	Monin-Obukhov viscosity profiles in the surface layer:
\begin{equation}
	\label{eq:ND_StratifiedCase_viscosities_SL}
	K_m = \kappa u_\star\frac{z+ z_{0M}}{\phi_m(z/L_{MO})} ~~\text{and}~~
K_\theta = \kappa u_\star\frac{z+ z_{0M}}{\phi_h(z/L_{MO})}
\end{equation}
\eqref{eq:ND_StratifiedCase_viscosities_assumption}
together with \eqref{eq:ND_StratifiedCase_viscosities_SL} put
a constraint on $\phi_z$ in the surface layer:
$\phi_z = \frac{C_m\phi_m(z/L_{MO})}{C_s\phi_h(z/L_{MO})}
		\forall z\leq \delta_{\rm sl}$.
\item Quasi-equilibrium of the TKE equation:
\begin{equation}
	\label{eq:ND_StratifiedCase_TKE_quasi_equilibrium}
	c_\epsilon \frac{e^{3/2}}{l_\epsilon}=K_m ||\partial_z u||^2 - \frac{g}{\theta_{ref}} K_\theta \partial_z \theta
\end{equation}
\end{enumerate}
We assume that $l_\epsilon$ in
\eqref{eq:ND_StratifiedCase_TKE_quasi_equilibrium} is taken at
time index $n$, so that the energy can be integrated in time
with a proper boundary condition before computing the mixing
length. Then, we assume that $l_m = \sqrt{l_{up}l_{down}}$ and
$l_\epsilon = \min(l_{up}, l_{down})$.
The characteristic length $l_{up}$ (resp. $l_{down}$) indicates
how much the turbulent mixing is acting upwards (resp. downward).
In the surface layer, it is hence natural to follow the
procedure \eqref{eq:ND_StratifiedCase_lD80} for $l_{up}$,
using the MOST profiles for the shear and buoyancy.
We derive the surface value of $l_{down}$ to link Monin-Obukhov
Similarity Theory with the turbulent closure used here.
\par
Simplifying \eqref{eq:ND_StratifiedCase_TKE_quasi_equilibrium}
with previous equations gives:
\begin{equation}
	\label{eq:ND_StratifiedCase_TKE_quasi_equilibrium_simplified}
	e = \min(l_{up}^{2/3}, l_{down}^{2/3})\left(
	\frac{u_\star}{c_\epsilon} 
	\left({u}_\star^2
	\frac{\phi_m(z/L_{MO})}{\kappa (z+z_{0M})}
	- \frac{g}{\theta_{\rm ref}}\theta_\star
	\right)
	\right)^{2/3}
\end{equation}

Now, \eqref{eq:ND_StratifiedCase_viscosities_SL} gives
\begin{equation}
	\label{eq:ND_StratifiedCase_solution_l_down1}
	l_{down}(e) = \frac{1}{l_{up} e} \left(
	\frac{\kappa u_\star}{C_m}
	\frac{z + z_{0M}}{\phi_m(z/L_{MO})}
\right)^2
\end{equation}
$l_{down}$ is limited by the distance to the bottom only
in the free-turbulence zone. In the SL, it keeps its value
\eqref{eq:ND_StratifiedCase_solution_l_down1}
so that \eqref{eq:ND_StratifiedCase_viscosities_SL} is
verified.
We inject \eqref{eq:ND_StratifiedCase_TKE_quasi_equilibrium_simplified}
into the previous equation and get
\begin{equation}
	\label{eq:ND_StratifiedCase_solution_l_down2}
	\begin{cases}
	l_{down}^{5/3} = \frac{1}{l_{up}} \frac{u_\star^{4/3}\left(
	\frac{\kappa}{C_m}
	\frac{z + z_{0M}}{\phi_m(z/L_{MO})}
	\right)^2}{
	\left({u}_\star^2
	\frac{\phi_m(z/L_{MO})}{c_\epsilon\kappa (z+z_{0M})}
	- \frac{g}{\theta_{\rm ref}c_\epsilon}\theta_\star
	\right)^{2/3}} ~~~ {\rm if } ~~l_{down} < l_{up}\\
	l_{down} = \frac{1}{l_{up}^{5/3}} \frac{u_\star^{4/3}\left(
	\frac{\kappa}{C_m}
	\frac{z + z_{0M}}{\phi_m(z/L_{MO})}
	\right)^2}{
	\left({u}_\star^2
	\frac{\phi_m(z/L_{MO})}{c_\epsilon\kappa (z+z_{0M})}
	- \frac{g}{\theta_{\rm ref}c_\epsilon}\theta_\star
	\right)^{2/3}} ~~~ {\rm otherwise}\\
	\end{cases}
\end{equation}
It is actually sufficient to use
\eqref{eq:ND_StratifiedCase_solution_l_down1}
to compute $l_{down}$ explicitly. It also guarantees that
the MOST viscosity and the MOST diffusivity numerically
scale with $l_m\sqrt{e}$.
However, by using \eqref{eq:ND_StratifiedCase_solution_l_down2}
the boundary condition for $e(z \leq \delta_{\rm sl})$ is more
stable. {\color{red} TODO justification empirique, j'avais
vu ça sur un cas que je retrouve pas. Dans l'océan ça
a pas l'air de poser problème}
