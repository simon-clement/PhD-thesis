\tableofcontents
\section{Introduction}
\begin{itemize}
\item The solution obtained with a discretization
	should be similar to the continuous solution.
\item The continuous solution should be recovered when
	the space step tends to 0.
\item The height of the surface layer
	is usually determined by the discretization.
\item This chapter presents a discretization such that
	the surface layer can be chosen for physical reasons,
		instead of numerical ones.
\item We want the discretization to be robust with regards to
	the space step. In particular, when the space step
		tends to 0, the surface layer should still
		be parametrized with the same wall law.
\item {\color{red} log-layer mismatch ref: since the characteristic
	size of the turbulent eddies in the surface layer are
		proportional to the distance to the surface,
		it should not be assumed that we solve
		correctly the mechanisms in the first levels
		of a finite differences classical approach}
\item The model used to derive this discretization is a 1D Ekman
	equation, with a forcing representing a geostrophic guide.
		The turbulent viscosity is computed with a
		one-equation turbulence closure model.
		{\color{red} TODO find reference}
\item We begin with a neutral stratification for pedagogical purposes,
	then apply the same concepts to a stratified column of
		atmosphere.
\end{itemize}
\section{Neutral case}
In this section, we assume that the stratification is neutral.
There is no effect of the stratification on the turbulent viscosity
so the wind speed $u(z, t)$ can be integrated in time
without the temperature and humidity profiles.
{\color{red} presentation of subsections}
\subsection{Continuous Model and Finite Volumes discretization}
\subsubsection{Continuous equations: two separate domains}
\label{sec:ND_NeutralCase}
The continuous equation above the surface layer
($z > \delta_{\rm sl}$) is
\begin{equation}
	\label{eq:ND_NeutralCase_EkmanEq}
  (\partial_t + if) u - \partial_z (\partial_z K_u u) = if u_G
\end{equation}
where $u_G$ is a constant value representing the geostrophic guide.
$f$ is the Coriolis parameter and $K_u$ the turbulent viscosity.
The profile of $K_u$ will be detailed
{\color{red}in section \ref{sec:ND_TurbulentViscosity}}.
inside the surface layer ($z \leq \delta_{\rm sl}$), the flux
$K_u \partial_z u$ is constant: {\color{red} TODO passer un peu plus de temps dessus ?}
\begin{equation}
	\label{eq:ND_NeutralCase_constantFlux}
	\left.K_u \partial_z u \right|_{z\leq \delta_{\rm sl}}
	= u_\star^2
	\frac{u(\delta_{\rm sl}, t)}{||u(\delta_{\rm sl}, t)||}.
\end{equation}
The size of the turbulent eddies at height $z$
is proportional to the distance to the surface $z$.
{\color{red} log-layer mismatch ref}. Combining molecular and
turbulent viscosities gives 
$K_u(z\leq \delta_{sl}) = \kappa u_\star z + K_{u, {\rm mol}}
= \kappa u_\star (z + z_{\star})$.
It follows that
\begin{equation}
\label{eq:ND_NeutralCase_WallLaw}
	||u(z, t) - u(0, t)|| = \frac{{u_\star}}{\kappa}
	\log(1+\frac{z}{z_{\star}}).
\end{equation}
A typical integration in time from $u(z, t^{n})$ to
$u(z, t^{n+1})$ is:
\begin{enumerate}
  \item Use \eqref{eq:ND_NeutralCase_WallLaw} to compute 
	  $u_\star = \frac{\kappa ||u(z, t^n)||}
			{\log(1+\frac{z}{z_\star})}$
  \item Integrate in time \eqref{eq:ND_NeutralCase_EkmanEq}
  using \eqref{eq:ND_NeutralCase_constantFlux} as a boundary condition
		either of Neumann type ($\left.K_u \partial_z u
		\right|_{z\leq \delta_{\rm sl}, t^{n+1}}
	= u_\star^2 \frac{u(\delta_{\rm sl}, t^n)}
		{||u(\delta_{\rm sl}, t^n)||}$)
		or of Robin type ($\left.K_u \partial_z u
		\right|_{z\leq \delta_{\rm sl}, t^{n+1}}
		- \frac{u_\star^2} {||u(\delta_{\rm sl}, t^n)||}
		u(\delta_{\rm sl}, t^{n+1}) = 0$)
\end{enumerate}

\subsubsection{Discretization with Finite volumes}
We define here the discretization used throughout all the present
section. The space domain is divided into $M$ cells delimited by
heights $(z_0=0, .., z_m, .., z_M)$. The size of the $m$-th cell
is $h_{m-\frac{1}{2}}=z_{m}-z_{m-1}$ and the average of $u(z, t)$
over this cell is 
$\overline{u}_{m-\frac{1}{2}}=\frac{1} {h_{m-\frac{1}{2}}}
\int_{z_{m-1}}^{z_m}u(z, t)dz$.
The space derivative of $u$ at $z_m$ is noted $\phi_{m}$.
Averaging \eqref{eq:ND_NeutralCase_EkmanEq} over a cell gives
the semi-discrete equation
\begin{equation}
\label{eq:ND_NeutralCase_semiDiscreteEkmanEq}
	(\partial_t + if) \overline{u}_{m+\frac{1}{2}} - 
	\frac{K_{u, m+1} \phi_{m+1} - K_{u, m} \phi_{m}}
		{h_{m+\frac{1}{2}}} = i f u_G.
\end{equation}
The reconstruction of $u(z, t) = {\cal S}_{m+\frac{1}{2}}
				(z - z_{m+\frac{1}{2}})$
				inside a cell must be decided
to pursue the derivation of the scheme. The simplest choice is
a quadratic polynomial,
${\cal S}_{m+\frac{1}{2}}(\xi) = r_0 + r_1 \xi + r_2 \xi^2$ where
$-\frac{h_{m+1/2}}{2} \leq \xi \leq \frac{h_{m+1/2}}{2}$.
Averaging ${\cal S}_{m+\frac{1}{2}}$ over the cell and
prescribing its space derivative at $z_{m}$ and $z_{m+1}$
($\xi=-\frac{h_{m+\frac{1}{2}}}{2}, \frac{h_{m+\frac{1}{2}}}{2}$)
lead to the following system:
\begin{equation}
    \begin{pmatrix}
    \overline{u}_{m+1/2} \\
    h_{m+\frac{1}{2}} \phi_m \\
	    h_{m+\frac{1}{2}} \phi_{m+1}
    \end{pmatrix} = 
    \begin{pmatrix}
    1 & 0 & \frac{1}{12} \\
    0 & 1 & -1 \\
    0 & 1 & 1 \\
    \end{pmatrix}
    \begin{pmatrix}
    r_0 \\
    r_1 h_{m+\frac{1}{2}} \\
    r_2 h_{m+\frac{1}{2}}^2
    \end{pmatrix}
\end{equation}
The reconstruction of $u(z)$ between $z_m$ and $z_{m+1}$
is then
\begin{equation}
\label{eq:ND_NeutralCase_quadraticReconstruction}
{\cal S}_{m+\frac{1}{2}}(\xi) =
	\Bar{u}_{m+\frac{1}{2}} + 
	\frac{\phi_{m+1}^{} + \phi_{m}^{}}{2} \xi
	+ \frac{\phi_{m+1}^{} - \phi_{m}^{}}{2h_{m+1/2}}
	\left(\xi^2 - \frac{h_{m+1/2}^2}{12}\right).
\end{equation}

The continuity of the solution at cell interfaces (${\cal S}_{m-\frac{1}{2}}\left(\frac{h_{m-1/2}}{2}\right) = {\cal S}_{m+\frac{1}{2}}\left(-\frac{h_{m+1/2}}{2}\right)$) is equivalent to
%
\begin{equation}
\label{eq:ND_NeutralCase_continuityEquationFV}
\frac{h_{m-1/2}}{6} \phi_{m-1} 
+ \frac{2h_{m}}{3} \phi_m  
+ \frac{h_{m+1/2}}{6} \phi_{m+1} = \Bar{u}_{m+\frac{1}{2}} - \Bar{u}_{m-\frac{1}{2}}
\end{equation}
where $h_m = \frac{h_{m-1/2} + h_{m+1/2}}{2}$.
Combining \eqref{eq:ND_NeutralCase_semiDiscreteEkmanEq}
and \eqref{eq:ND_NeutralCase_continuityEquationFV} finally gives
the prognostic equation to integrate
$\partial_z u$ in time:
\begin{equation}
\begin{aligned}
\label{eq:ND_NeutralCase_prognosticEqFV}
(\partial_t + if) \left( \frac{h_{m-1/2}}{6h_m} \phi_{m-1} 
+ \frac{2}{3} \phi_m  
+ \frac{h_{m+1/2}}{6h_m} \phi_{m+1} \right)& \\
-
    \left(
	\frac{K_{u, m+1}}{h_m h_{m+1/2}}\phi_{m+1} - \frac{2 K_{u,m}}{h_{m-1/2} h _{m+1/2}}\phi_m + \frac{K_{u,m-1}}{h_m h_{m-1/2}}\phi_{m-1}
    \right)
&= 0
\end{aligned}
\end{equation}
To reconstruct the solution, $\overline{u}$ should also be 
integrated in time with \eqref{eq:ND_NeutralCase_semiDiscreteEkmanEq}.
\eqref{eq:ND_NeutralCase_prognosticEqFV} and
\eqref{eq:ND_NeutralCase_semiDiscreteEkmanEq} are hence the two 
equations defining our finite volumes discretization.

\paragraph{Fourth order compact scheme}
To get a more accurate scheme,
a fourth degree polynomial can also be used. If
${\cal S}_{m+\frac{1}{2}}^4(\xi) = r_0^4 + r_1^4 \xi + r_2^4 \xi^2 
+ r_3^4 \xi^3 + r_4^4 \xi^4$, we can recover a fourth order compact
scheme by putting as a constraint that the reconstruction
on the boundaries of the cell are
${\cal S}^4_{m+\frac{1}{2}}(\frac{h_{m+\frac{1}{2}}}{2}) =
\overline{u}_{m+\frac{1}{2}} + \frac{h_{m+\frac{1}{2}}}{12}\left(
\phi_m + 5\phi_{m+1}\right) $ and
${\cal S}^4_{m+\frac{1}{2}}(-\frac{h_{m+\frac{1}{2}}}{2}) =
\overline{u}_{m+\frac{1}{2}} - \frac{h_{m+\frac{1}{2}}}{12}\left(
5\phi_m + \phi_{m+1}\right)$.
Then the reconstruction is given by
\begin{equation}
    \begin{pmatrix}
    r_0^4 \\
    r_1^4 h_{m+\frac{1}{2}} \\
    r_2^4 h_{m+\frac{1}{2}}^2 \\
    r_3^4 h_{m+\frac{1}{2}}^3 \\
    r_4^4 h_{m+\frac{1}{2}}^4
    \end{pmatrix}
     = 
    \begin{pmatrix}
    1 & 0 & \frac{1}{12} & 0 & \frac{1}{80} \\
    0 & 1 & -1 & \frac{3}{4} & -\frac{1}{2} \\
    0 & 1 & 1 & \frac{3}{4} & \frac{1}{2} \\
    1 & -\frac{1}{2} & \frac{1}{4} & -\frac{1}{8}
    & \frac{1}{16} \\
    1 & \frac{1}{2} & \frac{1}{4} & \frac{1}{8}
    & \frac{1}{16} \\
    \end{pmatrix}^{-1}
    \begin{pmatrix}
    \overline{u}_{m+1/2} \\
    h_{m+\frac{1}{2}} \phi_m \\
	    h_{m+\frac{1}{2}} \phi_{m+1} \\
	    \overline{u} - \frac{5}{12} h_{m+\frac{1}{2}} \phi_m - \frac{1}{12} h_{m+\frac{1}{2}} \phi_{m+1} \\
	    \overline{u} + \frac{1}{12} h_{m+\frac{1}{2}} \phi_m + \frac{5}{12} h_{m+\frac{1}{2}} \phi_{m+1}
    \end{pmatrix}
\end{equation}

